<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Candidates â€¢ e-COMELEC</title>

  <!-- Global styles -->
  <link rel="stylesheet" href="EComelec.css">

  <!-- Candidates-only styles -->
  <link rel="stylesheet" href="list.css">

  <!-- Font Awesome -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css">
</head>

<body>

  <!-- Navigation (no more "Candidates" item) -->
  <nav>
    <div class="inner">
      <div class="logo">
        <img src="images/comelec.png" alt="COMELEC Logo">
        <div class="logo-text">
          <span class="university">SOUTHERN LUZON STATE UNIVERSITY LUCENA</span>
          <span class="commission">COMMISSION ON ELECTION</span>
        </div>
      </div>

      <ul>
        <li><a href="EComelec.html"><i class="fas fa-home"></i> Home</a></li>
        <li><a href="About.html"><i class="fas fa-info-circle"></i> About</a></li>
        <li><a href="vote.html"><i class="fas fa-vote-yea"></i> Vote</a></li>
        <li><a href="result.html"><i class="fas fa-chart-bar"></i> Results</a></li>
        <li><a href="contact.html"><i class="fas fa-envelope"></i> Contact</a></li>

        <!-- Profile -->
        <li class="profile-menu">
          <i id="profileBtn" class="fas fa-user-circle"></i>
          <div id="profileDropdown" class="dropdown">
            <p id="userName">Loading...</p>
            <button id="logoutBtn">Logout</button>
          </div>
        </li>
      </ul>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="hero hero-candidates scroll-animate">
    <div class="hero-inner">
      <span class="hero-pill">
        <i class="fas fa-users"></i> Official Candidates
      </span>
      <div class="hero-text">
        <h1>Meet Your Leaders</h1>
        <p>Get to know each candidate before casting your vote.</p>
      </div>
    </div>
  </header>

  <!-- CANDIDATE LIST (from database) -->
  <section class="candidates scroll-animate">
    <div class="candidates-inner">
      <h2 class="candidates-title">
        <i class="fas fa-user-tie"></i> Candidate Line-Up
      </h2>
      <p class="candidates-subtitle">
        Candidates are listed by position. Data is loaded from the official candidacy records.
      </p>

      <div id="candidateGroups" class="candidate-groups">
        <p class="loading-text"><i class="fas fa-spinner fa-spin"></i> Loading candidates...</p>
      </div>
    </div>
  </section>

  <!-- Footer (same as other pages) -->
  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Campus e-COMELEC. All Rights Reserved.</p>
      <div class="footer-icons">
        <a href="https://www.facebook.com/slsulucena.comelec"><i class="fab fa-facebook"></i> Facebook</a>
        <a href="mailto:info@slsecomelec.edu"><i class="fas fa-envelope"></i> Email</a>
        <a href="#"><i class="fas fa-map-marker-alt"></i> Location</a>
      </div>
    </div>
  </footer>

  <!-- Firebase + Dynamic Candidates -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGwXduXRNtB42biPJe0KJkqzxxdz9IuqU",
      authDomain: "e-commelec.firebaseapp.com",
      databaseURL: "https://e-commelec-default-rtdb.firebaseio.com",
      projectId: "e-commelec",
      storageBucket: "e-commelec.firebasestorage.app",
      messagingSenderId: "334086674865",
      appId: "1:334086674865:web:63766c30fd3e9a032e8590"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ========== PROFILE DROPDOWN ========== */
    const profileBtn = document.getElementById("profileBtn");
    const profileDropdown = document.getElementById("profileDropdown");
    const userNameEl = document.getElementById("userName");
    const logoutBtn = document.getElementById("logoutBtn");

    if (profileBtn) {
      profileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle("active");
      });
    }

    document.addEventListener("click", (e) => {
      if (
        profileDropdown &&
        !profileDropdown.contains(e.target) &&
        !profileBtn.contains(e.target)
      ) {
        profileDropdown.classList.remove("active");
      }
    });

    const savedEmail = localStorage.getItem("ec_userEmail");
    if (savedEmail) {
      userNameEl.textContent = savedEmail;
    } else {
      userNameEl.textContent = "Not Logged In";
    }

    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    /* ========== LOAD CANDIDATES FROM RTDB ========== */
    const candidacyRef = ref(db, "candidacy");

    onValue(candidacyRef, (snapshot) => {
      const data = snapshot.val() || {};
      renderCandidates(data);
    });

    function renderCandidates(candidacyData) {
      const container = document.getElementById("candidateGroups");
      container.innerHTML = "";

      const ids = Object.keys(candidacyData || {});
      if (!ids.length) {
        container.innerHTML = `<p class="loading-text">No candidates found.</p>`;
        return;
      }

      // Group by position
      const groups = {};
      ids.forEach((id) => {
        const c = candidacyData[id] || {};
        const position = c.position || "Unspecified Position";
        if (!groups[position]) groups[position] = [];

        groups[position].push({
          name: c.fullName || c.name || "Unnamed Candidate",
          position,
          party: c.partylist || c.party || "",
          section: c.section || c.yearSection || ""
        });
      });

      // Sort positions alphabetically
      const positions = Object.keys(groups).sort((a, b) => a.localeCompare(b));

      positions.forEach((position) => {
        const candidates = groups[position].sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        let cardsHtml = "";
        candidates.forEach((c) => {
          const hasMeta = c.party || c.section;
          cardsHtml += `
            <div class="candidate-card">
              <div class="candidate-avatar">
                <i class="fas fa-user-tie"></i>
              </div>
              <div>
                <h4 class="candidate-name">${c.name}</h4>
                <p class="candidate-position">${c.position}</p>
                ${
                  hasMeta
                    ? `<p class="candidate-meta">
                        ${
                          c.party
                            ? `<span class="candidate-tag"><i class="fas fa-flag"></i> ${c.party}</span>`
                            : ""
                        }
                        ${
                          c.section
                            ? `<span class="candidate-tag"><i class="fas fa-users"></i> ${c.section}</span>`
                            : ""
                        }
                      </p>`
                    : ""
                }
              </div>
            </div>
          `;
        });

        container.innerHTML += `
          <div class="candidate-group">
            <h3 class="candidate-group-title">${position}</h3>
            <div class="candidates-grid">
              ${cardsHtml}
            </div>
          </div>
        `;
      });
    }
  </script>

  <!-- Optional scroll animations if used elsewhere -->
  <script src="animation.js"></script>
</body>
</html>
